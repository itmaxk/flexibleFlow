# VPN Cascade Automator (VLESS Reality)

Скрипт для Ubuntu, который разворачивает каскадный VPN из двух узлов:
- `Foreign` (выходной сервер в иностранной юрисдикции)
- `RU` (входной bridge-сервер для пользователей)

Базовая логика маршрутизации:
- по умолчанию трафик идёт через `Foreign`
- российские домены и `geoip:ru` идут напрямую через `RU`

## Что делает текущий скрипт

Файл: `vless_cascade.py`

- Устанавливает `3x-ui` только при подтверждении (если панель не найдена).
- Настраивает VLESS+Reality inbound на `Foreign`.
- Настраивает каскад на `RU` (outbound на `Foreign` + routing rules).
- Генерирует клиентскую ссылку и QR-код.
- Позволяет изменить клиентский порт и SNI.
- Хранит маршруты в отдельном JSON: `/etc/vless-cascade/routes.json`.
- Если в маршрутах отсутствует default-политика, скрипт автоматически добавляет: `geosite:category-ru`, домены `.ru/.su/.рф` и `geoip:ru`.
- Валидирует входную VLESS-ссылку (UUID/SNI/pbk/sid/port) перед применением.
- Делает бэкап текущего `xrayConfig` перед изменением RU-маршрутизации.
- Позволяет откатить `xrayConfig` из последнего или выбранного бэкапа через меню.
- Перед применением RU-конфига и отката выполняет проверку `xray -test`.
- Поддерживает `safe mode` (без автоустановки зависимостей): `--safe` или `VLESS_CASCADE_SAFE_MODE=1`.

## Статус требований

Требования:
- меню из 2 пунктов (установка `RU` и `Foreign`) — неактуально
- удобное редактирование списков адресов (через Foreign / через RU) — выполнено
- безопасно и быстро — частично выполнено (усилена валидация и хранение настроек)
- опциональная UI-панель (`3x-ui`) — выполнено

Сейчас в коде:
- меню расширенное: настройка, регенерация, параметры клиента, редактор маршрутов, готовые профили.
- маршруты вынесены в `/etc/vless-cascade/routes.json`.
- установщик `3x-ui` запускается только по подтверждению.

## Быстрый запуск

На Ubuntu (на каждом сервере):

```bash
sudo python3 vless_cascade.py
```

Без автоустановки зависимостей:

```bash
sudo python3 vless_cascade.py --safe
```

Далее:
1. На иностранном сервере выберите пункт `1` и получите ссылку.
2. На RU сервере выберите пункт `2` и вставьте ссылку Foreign.
3. На RU сервере получите клиентскую ссылку/QR и импортируйте в клиент.

## Где редактируются маршруты

Файл: `/etc/vless-cascade/routes.json`

Поля:
- `direct_domains`: домены, которые идут напрямую через RU
- `direct_ips`: IP/geoip, которые идут напрямую через RU
- `proxy_domains`: домены, которые принудительно идут через Foreign
- `proxy_ips`: IP/подсети, которые принудительно идут через Foreign

Пример текущей логики:
- direct: `geosite:category-ru`
- direct: `geoip:ru`, `geoip:private`
- proxy: весь остальной `tcp,udp`

## Готовые профили маршрутов

Через меню можно быстро применить профиль:
- `RU only direct (recommended)`: RU напрямую, остальное через Foreign
- `Mixed (RU + Telegram direct)`: RU и Telegram напрямую, остальное через Foreign
- `Full proxy (only private direct)`: напрямую только private-сети, остальное через Foreign

После применения профиль записывается в `/etc/vless-cascade/routes.json`.

## Бэкапы конфигурации

Перед изменением `xrayConfig` на RU-сервере создаётся бэкап:
- каталог: `/etc/vless-cascade/backups`
- формат: `xrayConfig-XXXXXXXX.json`

Это позволяет быстро откатить маршрутизацию при ошибке в правилах.

Откат выполняется через пункт меню:
- `Откатить xrayConfig из бэкапа`
- можно восстановить последний бэкап или выбрать конкретный из списка

## Безопасность (обязательно)

- Запускать только от `root` на чистом Ubuntu LTS.
- Закрыть всё лишнее в firewall, оставить только нужные порты.
- Ограничить доступ к панели `3x-ui` (IP whitelist / нестандартный порт / сложный пароль / 2FA).
- Регулярно обновлять ОС и `3x-ui`.
- Проверить NTP: рассинхрон времени ломает Reality.
- Не хранить публично клиентские ссылки, UUID и ключи.
- Использовать `--safe` на production-узлах, если автоустановка зависимостей недопустима.

## Производительность

- Для скорости держать `RU` и `Foreign` на VPS с хорошим peering.
- Избегать перегруженных регионов и дешёвых oversold-тарифов.
- Использовать `reality` + `vision` (как сейчас) для баланса скорость/обход.

## Альтернативы протоколу VLESS Reality

- `Hysteria2`: часто быстрее на плохих каналах (UDP-heavy), но отличается моделью маскировки.
- `TUIC`: тоже быстрый UDP-вариант, чувствителен к условиям сети и клиентам.
- `WireGuard`: очень быстрый и простой, но хуже по обфускации.

Для задач обхода DPI и гибкой маскировки VLESS Reality обычно остаётся самым практичным базовым выбором.

## Клиенты

- Android: `v2rayNG`, `NekoBox`, `Hiddify Next`
- iOS: `Streisand`, `FoXray`, `V2Box`
- Windows: `v2rayN`, `Nekoray`, `Hiddify Next`
- macOS: `FoXray`, `V2Box`
